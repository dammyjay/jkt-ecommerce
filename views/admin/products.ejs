

<div class="container">
  <div class="card">
    <div class="page-header" style="display:flex; gap:12px; justify-content:space-between; align-items:center;">
      <h1>üßë‚Äçüíº Manage Products</h1>

      <div style="display:flex; gap:10px;">
        <button class="btn btn-primary" onclick="openCreateModal()">‚ûï Upload Product</button>
        <button class="btn btn-secondary" onclick="openCategoryModal()">‚ûï Add Category</button>
      </div>
    </div>

    <!-- üß© Create Product Modal -->
    <div id="createModal" class="modal">
      <div class="modal-box">
        <span class="close" onclick="closeCreateModal()">&times;</span>
        <h2>Upload New Product</h2>

        <form 
          action="/products/admin/create" 
          method="POST" 
          enctype="multipart/form-data"
        >
          <label>Product Name</label>
          <input type="text" name="name" required>

          <label>Product Image</label>
          <input type="file" name="image" accept="image/*" onchange="previewCreateImage(event)">
          <img id="createPreview" class="image-preview">

          <label>Description</label>
          <textarea name="description" id="createDescription"></textarea>

          <label>Category</label>
          <select name="category_id" required>
            <option value="">Select Category</option>
            <% categories.forEach(category => { %>
              <option value="<%= category.id %>">
                <%= category.name %>
              </option>
            <% }) %>
          </select>


          <label>Price (‚Ç¶)</label>
          <input type="number" step="0.01" name="price" required>

          <label>Stock</label>
          <input type="number" name="stock" required>

          <button type="submit" class="btn btn-primary btn-full">Upload Product</button>
        </form>
      </div>
    </div>

    <div id="categoryModal" class="modal">
      <div class="modal-box">
        <span class="close" onclick="closeCategoryModal()">&times;</span>
        <h2>Upload New Product</h2>
        <form 
          action="/admin/categories/create" 
          method="POST"
        >
          <input 
            type="text" 
            name="name" 
            placeholder="New Category Name" 
            required
          >
          <button type="submit" class="btn btn-primary btn-full">
            Create Category
          </button>
        </form>
      </div>
    </div>

    <!-- ‚úÖ Product Table -->
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Image</th>
            <th>Name</th>
            <th>Description</th>
            <th>Category</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% products.forEach(product => { %>
            <tr>
              <td><%= product.id %></td>
              <td>
                <% if (product.image_url) { %>
                  <img src="<%= product.image_url %>" alt="<%= product.name %>" width="50" height="50" style="object-fit: cover; border-radius: 5px;">
                <% } else { %>
                  N/A
                <% } %>
              <td><%= product.name %></td>
              <td><%= product.description %></td>
              <td><%= product.category_name || 'Uncategorized' %></td>
              <td>‚Ç¶<%= product.price %></td>
              <td><%= product.stock %></td>
              <td style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn-edit" onclick='openEditModal(<%- JSON.stringify(product) %>)'>Edit</button>

                <button 
                  type="button"
                  class="btn-delete"
                  onclick="openDeleteModal('<%= product.id %>', '<%= product.name %>')"
                >
                  Delete
                </button>


              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</div>


<!-- üß© Edit Product Modal -->
<div id="editModal" class="modal">
  <div class="modal-box">
    <span class="close" onclick="closeEditModal()">&times;</span>
    <h2>Edit Product</h2>

    <form 
      id="editForm" 
      method="POST" 
      enctype="multipart/form-data"
      class="modal-form"
    >
      <label>Product Name</label>
      <input type="text" name="name" id="editName" required>

      <label>Change Image</label>
      <input type="file" name="image" accept="image/*" onchange="previewEditImage(event)">
      <img id="editPreview" class="image-preview">

      <label>Description</label>
      <textarea name="description" id="editDescription"></textarea>

      <select name="category_id" id="editCategory">
        <% categories.forEach(cat => { %>
          <option value="<%= cat.id %>"><%= cat.name %></option>
        <% }) %>
      </select>


      <label>Price (‚Ç¶)</label>
      <input type="number" step="0.01" name="price" id="editPrice" required>

      <label>Stock</label>
      <input type="number" name="stock" id="editStock" required>

      <button type="submit" class="btn btn-primary btn-full">Update Product</button>
    </form>
  </div>
</div>

<!-- ‚ùå Delete Confirmation Modal -->
<div id="deleteModal" class="modal" style="display: none;">
  <div class="modal-box center small">
    <span class="close" onclick="closeDeleteModal()">&times;</span>

    <h3>Delete Product</h3>
    <p>
      Are you sure you want to delete  
      <strong id="deleteProductName"></strong>?
    </p>

    <form id="deleteForm" method="POST">
      <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">
        Cancel
      </button>
      <button type="submit" class="btn btn-danger">
        Yes, Delete
      </button>
    </form>
  </div>
</div>

<script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>

<!-- Script for CKEditor -->
 <script>
let createEditor;
let editEditor;

// Create product editor
ClassicEditor
  .create(document.querySelector('#createDescription'), {
    placeholder: 'Write product description...',
    toolbar: [
      'heading', '|',
      'bold', 'italic', 'link',
      'bulletedList', 'numberedList',
      'blockQuote', '|',
      'undo', 'redo'
    ]
  })
  .then(editor => {
    createEditor = editor;
  })
  .catch(error => console.error(error));

// Edit product editor
ClassicEditor
  .create(document.querySelector('#editDescription'), {
    placeholder: 'Edit product description...',
    toolbar: [
      'heading', '|',
      'bold', 'italic', 'link',
      'bulletedList', 'numberedList',
      'blockQuote', '|',
      'undo', 'redo'
    ]
  })
  .then(editor => {
    editEditor = editor;
  })
  .catch(error => console.error(error));
</script>

<script>
/* CREATE PRODUCT FORM */
document.querySelector('#createModal form').addEventListener('submit', function () {
  if (createEditor) {
    document.getElementById('createDescription').value = createEditor.getData();
  }
});

/* EDIT PRODUCT FORM */
document.getElementById('editForm').addEventListener('submit', function () {
  if (editEditor) {
    document.getElementById('editDescription').value = editEditor.getData();
  }
});
</script>


<!-- Script for modals create and edit and delete -->
<script>
  const createModal = document.getElementById("createModal");
  const editModal = document.getElementById("editModal");

  function openCreateModal() {
    // createModal.style.display = "flex";
    createModal.classList.add("active");
  }

  function closeCreateModal() {
    // createModal.style.display = "none";
    createModal.classList.remove("active");
  }

  function openCategoryModal() {
    // categoryModal.style.display = "flex";
    categoryModal.classList.add("active");
  }

  function closeCategoryModal() {
    // categoryModal.style.display = "none";
    categoryModal.classList.remove("active");
  }

  function openEditModal(product) {
    const editModal = document.getElementById("editModal");
    // editModal.style.display = "flex";
    editModal.classList.add("active");

    document.getElementById("editName").value = product.name;
    // document.getElementById("editDescription").value = product.description;
    editEditor.setData(product.description || '');
    document.getElementById("editCategory").value = product.category_id;
    document.getElementById("editPrice").value = product.price;
    document.getElementById("editStock").value = product.stock;
    document.getElementById("editPreview").src = product.image_url || "";
    document.getElementById("editForm").action = `/products/admin/${product.id}/update`;
}


  function closeEditModal() {
    // editModal.style.display = "none";
    editModal.classList.remove("active");
  }

  function previewCreateImage(event) {
    document.getElementById("createPreview").src =
      URL.createObjectURL(event.target.files[0]);
  }

  function previewEditImage(event) {
    document.getElementById("editPreview").src =
      URL.createObjectURL(event.target.files[0]);
  }

  const deleteModal = document.getElementById("deleteModal");

  function openDeleteModal(id, name) {
    // deleteModal.style.display = "flex";
    deleteModal.classList.add("active");
    document.getElementById("deleteProductName").textContent = name;
    document.getElementById("deleteForm").action =
      `/products/admin/${id}/delete`;
  }

  function closeDeleteModal() {
    // deleteModal.style.display = "none";
    deleteModal.classList.remove("active");
  }

  window.onclick = function (event) {
    if (event.target === createModal) closeCreateModal();
    if (event.target === editModal) closeEditModal();
    if (event.target === categoryModal) closeCategoryModal(); 
    if (event.target === deleteModal) {
      closeDeleteModal();
    }
  };
</script>

